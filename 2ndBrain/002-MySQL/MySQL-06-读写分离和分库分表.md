
# MySQL-06-读写分离和分库分表

[TOC]

## 更新
* 2022/06/09，撰写


## 参考资料
* [MySQL 主从复制读写分离 | Segmentfault](https://segmentfault.com/a/1190000023775512)
* [MySQL 读写分离详解及同步延迟问题](https://codeantenna.com/a/lkuet4ljTY)
* [MySQL 分库分表方案 | 掘金](https://juejin.cn/post/6844903648670007310)
* [分库分表方案 | 腾讯云](https://cloud.tencent.com/developer/article/1623139)
* [大众点评订单系统分库分表实践 | 美团技术](https://tech.meituan.com/2016/11/18/dianping-order-db-sharding.html)



## 前言



### binlog
* [《MySQL是怎样运行的》从根儿上理解 MySQL](https://juejin.cn/book/6844733769996304392)，「binlog」章节

binlog（`binary log`）是二进制日志，可以记录数据库发生的变化，比如表的新建，表的修改，数据的插入和删除等。

binlog 的作用有 2 个
1. 用于主从复制
2. 用于恢复


使用 `show variables like 'log_bin';` 可以查看 binglog 日志是否打开。

```sql
mysql> show variables like 'log_bin';
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| log_bin       | ON    |
+---------------+-------+

```



### 库的最大连接数

以 MySQL 为例，当访问连接数过多或数据库设置的最大连接数太小时，会出现 `too many connections` 的错误。

MySQL 默认的最大连接数为 100，可以修改该值。MySQL 服务允许的最大连接数是 16384。




## 基于主从复制的读写分离




### 主从复制的原理
1. 当 Master 节点进行 insert、update、delete 操作时，会按顺序写入到 binlog 中。
2. Salve 从库连接 Master 主库，Master 有多少个 Slave 就会创建多少个 binlog dump 线程。
3. 当 Master 节点的 binlog 发生变化时，binlog dump 线程会通知所有的 Salve 节点，并将相应的 binlog 内容推送给 Slave 节点。
4. I/O 线程接收到 binlog 内容后，将内容写入到本地的 relay-log。
5. SQL 线程读取 I/O 线程写入的 relay-log，并且根据 relay-log 的内容对从数据库做对应的操作。


![](https://image-bed-20181207-1257458714.cos.ap-shanghai.myqcloud.com/back-end-2022/mysql-master-slave-copy-1.png)

### 读写分离

> 读写分离适用于读多写少的场景，对写多读少的场景，并不适用。

在主从复制的基础上，可进行读写分离，即主库进行写操作，从库进行读操作。



读写分离的实现方式有很多，包括
1. 基于 AOP 的方式
   * 对方法名进行判断，方法名中有 get、select、query 开头的则连接从库，其他的则连接主库。
2. MyCat
   * 阿里的开源产品
   * 支持读写分离，支持多种分库分表算法
   * 性能损耗 20% ~ 50%
   * 目前社区现状很不好，基本慢慢被抛弃
3. Apache ShardingSphere-JDBC
   * 轻量级 Java 架构，开源的分布式数据库中间件解决方案，由 JDBC、Proxy 两部分组成
   * 支持读写分离，支持多种分库分表算法
   * 性能损耗约 20%
   * 目前发展趋势较好


![](https://image-bed-20181207-1257458714.cos.ap-shanghai.myqcloud.com/back-end-2022/mysql-master-slave-copy-2.png)


### 存在的问题

基于主从复制实现的读写分离方案，主要存下如下几个问题
1. 主库数据丢失（可采用半同步机制解决）
2. 主从延迟（可采用并行复制解决）


#### 主库数据丢失

若主库宕机，写操作还没来得及写入 binlog 日志，会造成写入数据丢失。

对于「主库数据丢失」问题，可采用「半同步机制」解决。



MySQL 提供了一种「半同步复制」机制，也叫 `semi-sync` 复制，其过程如下
1. 主库写入 binlog 日志之后，就会将强制此时立即将数据同步到从库
2. 从库将日志写入自己本地的 relay log 之后，接着会返回一个 ack 给主库
3. 主库接收到至少一个从库的 ack 之后才会认为写操作完成了



#### 主从延迟

「主从延迟」指的是由于从机是通过 binlog 日志从 Master 同步数据的，由于某些原因造成了从机无法实时（或及时）读取到写入主库的数据（会有几十甚至几百毫秒的延迟）。

主从延迟产生的原因如下
* 硬件原因
* 主库并发，从库单线程重放
* 网络原因
* 执行大的事务



对于「主从延迟」问题，解决办法如下
1. 采用多主库方案，降低主库的并发量
2. 采用并行复制，缩短数据同步耗时
   * 从库开启多个线程，并行读取 relay log 中不同库的日志，然后并行重放不同库的日志，这是库级别的并行。
3. 写入主库并立刻查询时，规定直接从主库读取；超过一定时间后，从从库读取
   * Apache ShardingSphere-JDBC 框架规定了「同一线程且同一数据库连接内，如有写操作，以后的读操作均从主库读取，用于保证数据一致性」
4. 使用自增表
   * Mysql Proxy 中规定，在 Master 上做 insert 时，更新一张自增表。查询时，查询 Master 和 Slave 上的这张自增表的值是否一样。如果一样认为已经完成主从同步，可从从库读取，否则读取主库。



## 分库分表


读写分离方案中，只解决了读的扩展性，对于写操作，仍是单机（一个主库）操作。当写操作越来越多时，就要考虑分库分表（`Sharding`）了，对写操作进行拆分。



分库分表（`Sharding`）可分为两种方式
1. 垂直拆分
2. 水平拆分

> 分库分表的顺序应该是先垂直拆分，后水平拆分。因为垂直拆分更简单，更符合我们处理现实世界问题的方式。数据库是“有状态的”，相对于 Web 和应用服务来讲，是比较难实现“横向扩展”的。

### 垂直拆分


#### 优缺点

特点 
1. 垂直拆分是基于表或字段划分，拆分出的表的结构是不同的。

优点
1. 拆分后业务清晰，方便针对业务进行优化（专库专用按业务拆分）
2. 数据维护简单，按业务不同将业务放到不同机器上

#### 垂直分表


![](https://image-bed-20181207-1257458714.cos.ap-shanghai.myqcloud.com/back-end-2022/mysql-sharing-5.png)

* 垂直分表，即大表拆小表，基于列字段对表拆分
* 若表中的字段较多，可将不常用的、数据较大的、长度较长的（如 text 类型字段）的字段拆分到「扩展表」中
* 垂直分表可以避免查询时数据量太大造成的「跨页」问题


#### 垂直分库


![](https://image-bed-20181207-1257458714.cos.ap-shanghai.myqcloud.com/back-end-2022/mysql-sharing-4.png)

* 在一个系统中，按照不同的业务，将数据拆分到不同的数据库，并部署到多个服务器上（不要部署到一个服务器）
* 以电商系统为例，可以拆分出用户库，订单库，商品库，并部署到多个服务器上
* 垂直分库中，将拆分的库部署到多个服务器上，在一定程度上能够突破 IO、连接数及单机硬件资源的瓶颈；并且也便于服务的治理和降级。

### 水平拆分

业务量比较大的时候，即使做了垂直拆分，依然会存在以下问题
1. 如果单表的数据量大，读写压力依然很大
2. 受某种业务限制，一个业务影响到整个系统的性能，如电商系统中订单库的读写往往大于其他库

这个时候，可以考虑水平拆分进一步提升性能。


#### 优缺点

特点
1. 基于数据划分，表结构相同，数据不同

优点
1. 单库（表）的数据保持在一定的量（或减少），提高了系统的稳定性和负载能力
2. 切分表的结构相同，程序改造较少


缺点
1. 数据扩容有难度，维护量大
* 如早期按照 `userid % 2` 分两个库，后期想按照 `userid % 10` 分 10 个库，就会造成较大的改动，原有数据也要迁移
2. 拆分规则很难抽象出来
3. 分布式事务的一致性问题



#### 水平分表

![](https://image-bed-20181207-1257458714.cos.ap-shanghai.myqcloud.com/back-end-2022/mysql-sharing-3.png)

* 将数据量较大的单张表，按照某种规则（`RANGE` 或 `HASH`取模等），拆分到多张表中
* 水平分表中，拆分的多张表还是在同一个库中，所以库级别的数据库操作还是有 IO 瓶颈，不建议采用

#### 水平分库

![](https://image-bed-20181207-1257458714.cos.ap-shanghai.myqcloud.com/back-end-2022/mysql-sharing-2.png)

* 将单张表的数据切分到多个服务器上去，每个服务器具有相应的库与表，只是表中数据集合不同
* 水平分库分表能够有效的缓解单机和单库的性能瓶颈和压力，突破IO、连接数、硬件资源等的瓶颈


#### 拆分维度

1. RANGE
   * 如 1~1W 为一个表，1W~2W 为一个表
2. HASH 取模
   * 如对用户 ID 进行 HASH 取模，映射到不同的表中
3. 地理区域
   * 如按照华南，华北，东北等地理区域拆分
4. 时间
   * 按时间维度拆分，比如今年，去年，前年




### 存在的问题

分库分表后，存在如下问题
1. 事务支持
   * 分库分表后，需要执行分布式事务
2. 多库结果集合并（`group by`，`order by`）
3. 跨库 JOIN
   * 可通过表中添加冗余字段或使用中间件进行组装 JOIN




### 开源产品

1. sharding-sphere
2. TDDL（Taobao Distribute Data Layer）
3. MyCat

![](https://image-bed-20181207-1257458714.cos.ap-shanghai.myqcloud.com/back-end-2022/mysql-sharding-1.png)
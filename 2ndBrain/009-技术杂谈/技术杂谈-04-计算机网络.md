
# 技术杂谈-04-计算机网络

[TOC]


## 更新
* 2022/05/05，撰写


## Cookie-Session-Token
* ref 1-[Cookie，Session和Token对比 | Segmentfault](https://segmentfault.com/a/1190000022054795)


### cookie和session



![](https://image-bed-20181207-1257458714.cos.ap-shanghai.myqcloud.com/back-end-2022/cookie-session-id-1.png)

* 存储位置：cookie 是存储在客户端的，session 是存储在服务器端的。`sessionId` 会被存储在 cookie中，`sessionId` 是连接 cookie 和 session 的一道桥梁。
* 安全性：session 是存储在服务器端的，所以session 比 cookie 安全。
* 存取值的类型不同：cookie 只支持存字符串数据，想要设置其他类型的数据，需要将其转换成字符串。session 可以存任意数据类型。
* 有效期不同：cookie 可设置为长时间保持，比如我们经常使用的默认登录功能。session 一般失效时间较短，客户端关闭（默认情况下）或者 session 超时都会失效。
* 存储大小不同：单个 cookie 保存的数据不能超过 4K。session 可存储数据远高于 cookie，但是当访问量过多，会占用过多的服务器资源。



### token

* token 是访问资源接口（API）时所需要的资源凭证
* token 的身份验证流程如下图所示。

![](https://image-bed-20181207-1257458714.cos.ap-shanghai.myqcloud.com/back-end-2022/cookie-token-1.png)


session 和 token 对比而言
1. session 是一种记录服务器和客户端会话状态的机制，使服务端有状态化，可以记录会话信息。而 token 是令牌，访问资源接口（API）时所需要的资源凭证，**token 使服务端无状态化，不会存储会话信息。**
2. 作为身份认证，token 安全性比 session 好。
3. JSON Web Token（简称 `JWT`）是目前最流行的跨域认证解决方案。




## 分布式Session
* ref 1-[分布式session的几种解决方案 | 阿里云](https://developer.aliyun.com/article/842002)
* ref 2-[分布式集群环境下Session共享的解决方案](https://blog.51cto.com/u_14622170/4977473)



Session 的内容是存储在服务器端的，客户端通过 seesionId 和服务端进行交流。在单机环境下，服务端获取到客户端传来的 sessionId 并查找对应的 session 内容。若对应的 session 不存在，则创建一个新的 session。

如果采用分布式集群环境，如何做到session环境呢？有如下 4 种解决方案
1. 客户端存储 session
2. session 复制
3. session 黏性
4. session 持久化
5. session 共享（redis、spring-session）


### 客户端存储 session

直接将 session 信息存储在客户端，存储到客户端的 cookie 中。这样做虽然可以解决问题，但存在如下问题这
* 安全性存在问题
* cookie 对于数据类型（只支持存字符串数据）及数据大小（4kb）有所限制


### session 复制

将服务器 A 的 session，复制到服务器 B；同样将服务器 B 的 session 也复制到服务器 A。这样两台服务器的 session 就一致了。

像 Tomcat 等 web 容器都支持 session 复制的功能，在同一个局域网内，一台服务器的 session 会广播给其他服务器。

该方案的缺点是
* 同一个网段内服务器太多，每个服务器都会去复制 session，会造成服务器内存浪费。


### session 粘性

利用 Nginx 服务器的反向代理，采用 `ip_hash` 的负载均衡策略，将客户端和服务器进行绑定，Ngnix 每次都将同一用户的所有请求转发至同一台服务器上。

该方案的缺点是
* 如果某台服务器宕机了，则该服务器对应的 session 会丢失


### session 持久化
将 session 存储至数据库中，像操作数据一样操作 session。


### session 共享（redis、spring-session）

将所有服务器的 session 统一管理，可以使用 redis，memcache 等缓存系统存储 session，系统设计如下图所示。


![distributed-session-redis-1](https://image-bed-20181207-1257458714.cos.ap-shanghai.myqcloud.com/back-end-2022/distributed-session-redis-1.png)


Spring 官方提供的 `spirng-session` 也是这样处理 session 一致性问题的，也是目前业内主流的解决方案。


Spring Session 提供了对 redis，mongodb，mysql 等常用的存储库的支持。Spring Session 提供与 HttpSession 的透明整合，这意味着开发人员可以使用Spring Session 支持的实现切换 HttpSession 实现。

* Spring Session 相关依赖

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.session</groupId>
    <artifactId>spring-session-data-redis</artifactId>
</dependency>

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-pool2</artifactId>
</dependency>
```
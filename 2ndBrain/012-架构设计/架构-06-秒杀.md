# 架构-06-秒杀


[TOC]


## 更新
* 2022/06/28，撰写





## 参考资料
* [高并发秒杀的设计精要与实现 | 掘金小册](https://juejin.cn/book/7008372989179723787)
* [京东秒杀架构升级优化实践 | 京东零售技术](https://mp.weixin.qq.com/s/bo46q8ohuk78fqXJTaQavQ)



## 库存问题
* [电商库存系统的防超卖和高并发扣减方案 | 京东零售技术](https://mp.weixin.qq.com/s/XvmQQ1_EtXKTm8J0k3K63Q)




### 库存扣减

库存扣减，目前主流有两种方式
1. 下单减库存，即用户下单成功时减少库存数量
2. 付款减库存，即用户支付完成并反馈给平台后再减少库存数量


两种方式各有优缺点，因此，需结合实际场景进行考虑，如秒杀、抢购、促销活动等，可使用下单减库存的方式。而对于产品库存量大，并发流量没有那么强的产品使用付款减库存的方式。


#### 下单减库存

即用户下单成功时减少库存数量

* 优势：用户体验友好，系统逻辑简洁；
* 缺点：会导致恶意下单或下单后却不买，使得真正有需求的用户无法购买，影响真实销量
* 解决办法
  * 设置订单有效时间，若订单创建成功 N 分钟不付款，则订单取消，库存回滚；
  * 限购，用各种条件来限制买家的购买件数，比如一个账号、一个ip，只能买一件；
  * 风控，从技术角度进行判断，屏蔽恶意账号，禁止恶意账号购买。

#### 付款减库存

即用户支付完成并反馈给平台后再减少库存数量
* 优势：减少无效订单带来的资源损耗；
* 缺点：因第三方支付返回结果存在时差，同一时间多个用户同时付款成功，会导致下单数目超过库存，商家库存不足容易引发断货和投诉，成本增加。
* 解决办法
  * 付款前再次校验库存，如确认订单要付款时再验证一次，并友好提示用户库存不足；
  * 增加提示信息：在商品详情页，订单步骤页面提示不及时付款，不能保证有库存等





### 如何防止超卖
1. 数据库悲观锁（不适用于高并发场景）
2. 数据库乐观锁：引入版本号概念，查询库存时获得版本号 v1，扣减库存时获得版本号 v2，只有两者一致时才扣减
3. 使用 Redis，将扣减库存拆分为「超卖校验」和「扣减数据的持久化」两个步骤

### 使用 Redis 防止超卖

扣减库存，其实包含两个过程
1. 超卖校验
2. 扣减数据的持久化

在秒杀高并发场景下，可以将这两个过程分开，使用 Redis 防止超卖；通过 Redis 防超卖后，扣减数据的持久化过程中只做库存扣减即可。


在「使用 Redis 进行超卖校验」时，如果出现热 Sku，就会打向 Redis 单片，造成单片性能抖动，这个时候可对热 Sku 进行「限流」，比如采用滑动窗口法进行限流。在滑动窗口限流法中，可以设定每 10ms 一个时间窗，对每个时间窗的热 Sku 库存扣减请求进行计数，单台服务器超过计数进行限流，若 10ms 超过 2 个就限流，那么 1s 一台服务器就是 200 个，50 台服务器一秒就可以卖出 1 万个货。



此外，在「Redis 超卖校验」时候，可以先校验下用户是否已经购买和该商品是否不存在，拦截一些不必要的请求，后续再进行库存扣减。可以使用 LUA 脚本保证原子性。

上述描述中，在查询「该商品是否不存在」时，为了避免多个请求去查 DB，可以使用 Redis 分布式锁。



### MySQL字段-无符号数

在设计数据表的库存字段时，数据类型设置为「无符号整数」，这样在执行 SQL 语句更新库存字段时，SQL 语会报错，控制字段值不为负数。


